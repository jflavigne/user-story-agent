---
name: constant-extract
description: Extract magic literals into organized constant modules
---

# Constant Extract Skill

Extract magic literals identified by `/constant-audit` into organized constant modules with proper imports.

## Usage

```
/constant-extract <path> [--inventory <file>] [--domain <domain>] [--dry-run]
```

## Parameters

| Parameter | Description | Default |
|-----------|-------------|---------|
| `<path>` | Directory to refactor (required) | - |
| `--inventory` | Use existing audit JSON file | Run audit first |
| `--domain` | Extract only this domain | `all` |
| `--dry-run` | Show changes without applying | `false` |

### Domains

| Domain | Creates Module | Contains |
|--------|---------------|----------|
| `ports` | `constants/network.ts` | Port numbers, hosts, URLs |
| `timeouts` | `constants/timeouts.ts` | Duration values (with `_MS`, `_S` suffixes) |
| `api-keys` | `constants/api.ts` | Contract strings (method names, JSON keys) |
| `env` | `constants/config.ts` | Environment variable defaults |
| `limits` | `constants/limits.ts` | Buffer sizes, retry counts, thresholds |

## Implementation

### Phase 1: Load Inventory

If `--inventory` provided, load JSON. Otherwise run `/constant-audit` first.

### Phase 2: Plan Module Structure

```
<path>/constants/
├── index.ts          # Re-exports all constants
├── network.ts        # Ports, hosts, URLs
├── timeouts.ts       # Duration values
├── api.ts            # Contract strings
├── config.ts         # Environment defaults
└── limits.ts         # Buffer sizes, thresholds
```

**Module Template:**
```typescript
/**
 * <Domain> constants.
 * Auto-generated by /constant-extract. Manual edits preserved.
 */

// === <Category> ===
export const CONSTANT_NAME = value; // Original: file:line
```

### Phase 3: Generate Constants

For each literal in the audit:

1. **Validate suggested name** - Ensure SCREAMING_SNAKE_CASE
2. **Check for duplicates** - Same name, different value = error
3. **Add unit suffix** - `_MS` for milliseconds, `_S` for seconds, `_BYTES` for sizes
4. **Add source comment** - Document original location

**Example Output:**
```typescript
// constants/network.ts
/**
 * Network configuration constants.
 */

// === Ports ===
export const WEBSOCKET_PORT = 8765; // transport/client.ts:42
export const MJPEG_PORT = 8081; // video/server.ts:15
export const REST_API_PORT = 8080; // api/server.ts:23

// === Hosts ===
export const DEFAULT_HOST = 'localhost'; // config/defaults.ts:12
```

### Phase 4: Apply Replacements

Use `cursor_dispatch` to process files:

```
cursor_dispatch:
  task: |
    Refactor to use constants from constants/network.ts:

    Files: transport/client.ts, daemon/server.ts

    Replacements:
    - 8765 → WEBSOCKET_PORT (add: import { WEBSOCKET_PORT } from '../constants/network')

    Rules:
    - Add imports at top of file
    - Replace ALL occurrences
    - Do NOT modify test files

    After changes, run: npm test
  mode: local
```

### Phase 5: Validation

After each batch:

```bash
# Run tests
npm test

# Run linter
npm run lint

# Verify no raw literals remain
grep -r "8765" src/  # Should NOT find raw literal
```

## Dry-Run Output

```
=== Constant Extraction Plan ===
Path: /path/to/project
Domain: ports

--- Modules to Create ---
constants/network.ts (NEW)
  + WEBSOCKET_PORT = 8765
  + MJPEG_PORT = 8081

--- Files to Modify ---
transport/client.ts
  Line 42: port: 8765 → port: WEBSOCKET_PORT
  + import: import { WEBSOCKET_PORT } from '../constants/network'

--- Summary ---
New files: 1
Modified files: 5
Constants created: 3
Literals replaced: 12

Run without --dry-run to apply changes.
```

## Examples

### Extract Only Network Constants
```
/constant-extract src/ --inventory audit.json --domain ports
```

### Dry-Run to Preview Changes
```
/constant-extract src/ --inventory audit.json --dry-run
```

### Quick Extraction Without Prior Audit
```
/constant-extract src/transport/  # Runs audit internally
```

## Related

- **Audit Skill:** `/constant-audit` (run before extraction)
- **Best Practices:** `.claude/skills/constants/best-practices.md`
